<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Data Pengguna</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .role-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-btn {
            padding: 12px 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .role-btn:hover, .role-btn.active {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-hint {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .section-title {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .admin-login {
            max-width: 400px;
            margin: 0 auto;
        }

        .admin-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            width: 300px;
        }

        .child-form {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .child-form h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            color: #ccc;
        }

        .progress-step.active {
            color: #667eea;
        }

        .progress-step.completed {
            color: #28a745;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ccc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .progress-step.active .step-number {
            background: #667eea;
        }

        .progress-step.completed .step-number {
            background: #28a745;
        }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .captcha-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .captcha-display {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 24px;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 8px;
            margin: 10px 0;
            letter-spacing: 3px;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            user-select: none;
            display: inline-block;
            min-width: 150px;
        }

        .captcha-input {
            font-size: 18px;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
            border: 3px solid #e1e8ed;
            padding: 12px;
            width: 200px;
            margin: 10px;
        }

        .captcha-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .captcha-refresh {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .captcha-refresh:hover {
            background: #5a6268;
            transform: scale(1.05);
        }
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Sistem Manajemen Data Pegawai</h1>
            <p>Platform Modern untuk Pengelolaan Data Kepegawaian</p>
        </div>

        <div class="role-selector">
            <button class="role-btn active" onclick="showSection('user')">üë§ Portal Pengguna</button>
            <button class="role-btn" onclick="showSection('admin')">üîê Panel Admin</button>
        </div>

        <!-- User Section -->
        <div id="user-section" class="section active">
            <h2 class="section-title">üìù Form Pendaftaran Data Pegawai</h2>
            
            <div class="progress-indicator">
                <div class="progress-step active" id="step1">
                    <span class="step-number">1</span>
                    <span>Data Utama</span>
                </div>
                <div class="progress-step" id="step2" style="margin-left: 20px;">
                    <span class="step-number">2</span>
                    <span>Data Lanjutan</span>
                </div>
            </div>

            <div class="alert alert-success" id="successAlert">
                ‚úÖ Data berhasil disimpan!
            </div>

            <div class="alert alert-danger" id="errorAlert">
                ‚ùå Mohon lengkapi semua field yang wajib diisi!
            </div>

            <!-- Step 1: Data Utama -->
            <div id="form-step1">
                <h3>üìã Data Utama Pegawai</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nip">NIP *</label>
                        <input type="text" id="nip" placeholder="Contoh: 198501012010011001">
                        <div class="form-hint">‚ö†Ô∏è Masukkan angka tanpa spasi dan karakter khusus</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="nama">Nama Lengkap *</label>
                        <input type="text" id="nama" placeholder="Contoh: DR. BUDI SANTOSO, S.H., M.H.">
                        <div class="form-hint">‚úèÔ∏è Gunakan huruf KAPITAL semua, sertakan gelar depan dan belakang jika ada</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ktp">No. KTP *</label>
                        <input type="text" id="ktp" placeholder="Contoh: 3374010101850001">
                        <div class="form-hint">‚ö†Ô∏è Masukkan 16 digit angka tanpa spasi dan karakter khusus</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="alamat">Alamat *</label>
                        <textarea id="alamat" rows="3" placeholder="Contoh: JL. MERDEKA NO. 123 RT 001 RW 002 KEL. SEMARANG TENGAH"></textarea>
                        <div class="form-hint">üè† Sesuai dengan alamat di Kartu Keluarga (KK)</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tempat_lahir">Tempat Lahir *</label>
                        <input type="text" id="tempat_lahir" placeholder="Contoh: SEMARANG">
                        <div class="form-hint">üåç Nama kota/kabupaten tempat lahir</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tanggal_lahir">Tanggal Lahir *</label>
                        <input type="date" id="tanggal_lahir">
                        <div class="form-hint">üìÖ Pilih tanggal lahir Anda</div>
                    </div>
                </div>
                
                <!-- Captcha Verification -->
                <div class="captcha-container">
                    <h4>üîê Verifikasi Keamanan</h4>
                    <p>Masukkan kode captcha di bawah ini untuk melanjutkan:</p>
                    <div class="captcha-display" id="captcha-display"></div>
                    <button type="button" class="captcha-refresh" onclick="generateCaptcha()">üîÑ Refresh</button>
                    <br>
                    <input type="text" class="captcha-input" id="captcha-input" placeholder="Masukkan kode" maxlength="6">
                    <div class="form-hint">üõ°Ô∏è Captcha diperlukan untuk keamanan data</div>
                </div>
                
                <div class="form-navigation">
                    <div></div>
                    <button class="btn btn-primary" onclick="nextStep()">Lanjut ke Data Lanjutan ‚Üí</button>
                </div>
            </div>

            <!-- Step 2: Data Lanjutan -->
            <div id="form-step2" style="display: none;">
                <h3>üìÑ Data Lanjutan Pegawai</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="agama">Agama</label>
                        <select id="agama">
                            <option value="">Pilih Agama</option>
                            <option value="ISLAM">Islam</option>
                            <option value="KRISTEN">Kristen</option>
                            <option value="KATOLIK">Katolik</option>
                            <option value="HINDU">Hindu</option>
                            <option value="BUDDHA">Buddha</option>
                            <option value="KONGHUCU">Konghucu</option>
                        </select>
                        <div class="form-hint">üïå Pilih agama yang dianut</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="npwp">NPWP</label>
                        <input type="text" id="npwp" placeholder="Contoh: 123456789012345">
                        <div class="form-hint">üí≥ 15 digit angka tanpa spasi dan karakter khusus</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="no_hp">No. HP</label>
                        <input type="text" id="no_hp" placeholder="Contoh: 081234567890">
                        <div class="form-hint">üì± Dimulai dengan 08, tanpa spasi</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="no_rekening">No. Rekening</label>
                        <input type="text" id="no_rekening" placeholder="Contoh: 1234567890">
                        <div class="form-hint">üè¶ Angka tanpa spasi dan karakter khusus</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="status_pernikahan">Status Pernikahan</label>
                        <select id="status_pernikahan" onchange="toggleMarriageFields()">
                            <option value="">Pilih Status</option>
                            <option value="BELUM_MENIKAH">Belum Menikah</option>
                            <option value="MENIKAH">Menikah</option>
                            <option value="CERAI_HIDUP">Cerai Hidup</option>
                            <option value="CERAI_MATI">Cerai Mati</option>
                        </select>
                        <div class="form-hint">üíç Status pernikahan saat ini</div>
                    </div>
                </div>

                <!-- Marriage Details -->
                <div id="marriage-details" style="display: none;">
                    <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informasi Keluarga</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nama_pasangan">Nama Suami/Istri</label>
                            <input type="text" id="nama_pasangan" placeholder="Nama lengkap suami/istri">
                        </div>
                        
                        <div class="form-group">
                            <label for="tanggal_lahir_pasangan">Tanggal Lahir Suami/Istri</label>
                            <input type="date" id="tanggal_lahir_pasangan">
                        </div>
                        
                        <div class="form-group">
                            <label for="tanggal_pernikahan">Tanggal Pernikahan</label>
                            <input type="date" id="tanggal_pernikahan">
                        </div>
                        
                        <div class="form-group">
                            <label for="tanggal_cerai">Tanggal Cerai (jika ada)</label>
                            <input type="date" id="tanggal_cerai">
                        </div>
                        
                        <div class="form-group">
                            <label for="tanggal_wafat">Tanggal Wafat (jika ada)</label>
                            <input type="date" id="tanggal_wafat">
                        </div>
                        
                        <div class="form-group">
                            <label for="pekerjaan_pasangan">Pekerjaan Suami/Istri</label>
                            <input type="text" id="pekerjaan_pasangan" placeholder="Pekerjaan suami/istri">
                        </div>
                    </div>
                </div>

                <!-- Children Information -->
                <div id="children-section">
                    <h4>üë∂ Informasi Anak</h4>
                    <div id="children-forms"></div>
                    <button type="button" class="btn btn-secondary" onclick="addChild()" style="margin-bottom: 20px;">+ Tambah Data Anak</button>
                </div>
                
                <div class="form-navigation">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Kembali</button>
                    <button class="btn btn-success" onclick="saveData()">üíæ Simpan Data</button>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="admin-section" class="section">
            <div id="admin-login" class="admin-login">
                <h2 class="section-title">üîê Login Admin</h2>
                <div class="form-group">
                    <label for="admin-password">Password Admin</label>
                    <input type="password" id="admin-password" placeholder="Masukkan password admin">
                    <div class="form-hint">üîë Masukkan password admin untuk akses panel</div>
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">üö™ Masuk Admin</button>
            </div>

            <div id="admin-panel" style="display: none;">
                <h2 class="section-title">üìä Panel Administrasi</h2>
                
                <div class="admin-controls">
                    <input type="text" class="search-box" id="search-input" placeholder="üîç Cari berdasarkan nama, NIP, atau KTP..." onkeyup="searchData()">
                    <div>
                        <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
                        <button class="btn btn-warning" onclick="clearAllData()">üóëÔ∏è Hapus Semua</button>
                        <button class="btn btn-secondary" onclick="adminLogout()">üö™ Logout</button>
                    </div>
                </div>

                <div id="stats-container" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="background: #667eea; color: white; padding: 20px; border-radius: 10px; flex: 1; min-width: 200px; text-align: center;">
                            <h3 id="total-records">0</h3>
                            <p>Total Pegawai</p>
                        </div>
                        <div style="background: #28a745; color: white; padding: 20px; border-radius: 10px; flex: 1; min-width: 200px; text-align: center;">
                            <h3 id="married-count">0</h3>
                            <p>Sudah Menikah</p>
                        </div>
                        <div style="background: #ffc107; color: #212529; padding: 20px; border-radius: 10px; flex: 1; min-width: 200px; text-align: center;">
                            <h3 id="single-count">0</h3>
                            <p>Belum Menikah</p>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NIP</th>
                                <th>Nama</th>
                                <th>No. KTP</th>
                                <th>Alamat</th>
                                <th>TTL</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="data-tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #666;">Belum ada data tersimpan</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Global variables
        let userData = JSON.parse(localStorage.getItem('pegawaiData')) || [];
        let childCounter = 0;
        let currentStep = 1;
        let currentCaptcha = '';

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateStatistics();
            generateCaptcha();
        });

        // Role switching
        function showSection(role) {
            // Update button states
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide sections
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(role + '-section').classList.add('active');
            
            if (role === 'admin') {
                loadData();
                updateStatistics();
            }
        }

        // Form step navigation
        function nextStep() {
            // Validate required fields in step 1
            const requiredFields = ['nip', 'nama', 'ktp', 'alamat', 'tempat_lahir', 'tanggal_lahir'];
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc3545';
                    isValid = false;
                } else {
                    field.style.borderColor = '#e1e8ed';
                }
            });

            if (!isValid) {
                showAlert('error', 'Mohon lengkapi semua field yang wajib diisi (ditandai *)');
                return;
            }

            // Validate formats
            if (!validateNIP(document.getElementById('nip').value)) {
                showAlert('error', 'Format NIP tidak valid! Harus berupa angka tanpa spasi dan karakter khusus.');
                return;
            }

            if (!validateKTP(document.getElementById('ktp').value)) {
                showAlert('error', 'Format KTP tidak valid! Harus berupa 16 digit angka.');
                return;
            }

            currentStep = 2;
            document.getElementById('form-step1').style.display = 'none';
            document.getElementById('form-step2').style.display = 'block';
            
            // Update progress
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }

        function prevStep() {
            currentStep = 1;
            document.getElementById('form-step2').style.display = 'none';
            document.getElementById('form-step1').style.display = 'block';
            
            // Update progress
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
        }

        // Captcha functions
        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let captcha = '';
            for (let i = 0; i < 6; i++) {
                captcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            currentCaptcha = captcha;
            document.getElementById('captcha-display').textContent = captcha;
            document.getElementById('captcha-input').value = '';
        }

        // Form validation functions
        function validateNIP(nip) {
            return /^\d+$/.test(nip) && nip.length >= 10;
        }

        function validateKTP(ktp) {
            return /^\d{16}$/.test(ktp);
        }

        function validateHP(hp) {
            return /^08\d{8,}$/.test(hp);
        }

        function validateNPWP(npwp) {
            return /^\d{15}$/.test(npwp);
        }

        // Marriage status handler
        function toggleMarriageFields() {
            const status = document.getElementById('status_pernikahan').value;
            const marriageDetails = document.getElementById('marriage-details');
            
            if (status === 'MENIKAH' || status === 'CERAI_HIDUP' || status === 'CERAI_MATI') {
                marriageDetails.style.display = 'block';
            } else {
                marriageDetails.style.display = 'none';
            }
        }

        // Children management
        function addChild() {
            if (childCounter >= 5) {
                showAlert('error', 'Maksimal 5 data anak yang dapat ditambahkan.');
                return;
            }
            
            childCounter++;
            const childrenForms = document.getElementById('children-forms');
            const childForm = document.createElement('div');
            childForm.className = 'child-form';
            childForm.innerHTML = `
                <h4>Anak ke-${childCounter}</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nama Anak</label>
                        <input type="text" id="anak_nama_${childCounter}" placeholder="Nama lengkap anak">
                    </div>
                    <div class="form-group">
                        <label>Tempat Lahir</label>
                        <input type="text" id="anak_tempat_lahir_${childCounter}" placeholder="Tempat lahir anak">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Lahir</label>
                        <input type="date" id="anak_tanggal_lahir_${childCounter}">
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin</label>
                        <select id="anak_jenis_kelamin_${childCounter}">
                            <option value="">Pilih</option>
                            <option value="LAKI-LAKI">Laki-laki</option>
                            <option value="PEREMPUAN">Perempuan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pekerjaan</label>
                        <input type="text" id="anak_pekerjaan_${childCounter}" placeholder="Pekerjaan anak (jika sudah bekerja)">
                    </div>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeChild(${childCounter})">üóëÔ∏è Hapus Anak ke-${childCounter}</button>
            `;
            
            childrenForms.appendChild(childForm);
        }

        function removeChild(childId) {
            const childForm = event.target.closest('.child-form');
            childForm.remove();
            childCounter--;
        }

        // Save data function
        function saveData() {
            // Validate captcha first
            const captchaInput = document.getElementById('captcha-input').value;
            if (!captchaInput) {
                showAlert('error', 'Mohon masukkan kode captcha!');
                document.getElementById('captcha-input').focus();
                return;
            }
            
            if (captchaInput.toUpperCase() !== currentCaptcha) {
                showAlert('error', 'Kode captcha salah! Silakan coba lagi.');
                document.getElementById('captcha-input').value = '';
                document.getElementById('captcha-input').focus();
                generateCaptcha();
                return;
            }

            // Validate optional fields with formats
            const npwp = document.getElementById('npwp').value;
            if (npwp && !validateNPWP(npwp)) {
                showAlert('error', 'Format NPWP tidak valid! Harus berupa 15 digit angka.');
                return;
            }

            const noHp = document.getElementById('no_hp').value;
            if (noHp && !validateHP(noHp)) {
                showAlert('error', 'Format No. HP tidak valid! Harus dimulai dengan 08.');
                return;
            }

            // Collect form data
            const formData = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                // Main data
                nip: document.getElementById('nip').value,
                nama: document.getElementById('nama').value.toUpperCase(),
                ktp: document.getElementById('ktp').value,
                alamat: document.getElementById('alamat').value,
                tempat_lahir: document.getElementById('tempat_lahir').value,
                tanggal_lahir: document.getElementById('tanggal_lahir').value,
                // Additional data
                agama: document.getElementById('agama').value,
                npwp: document.getElementById('npwp').value,
                no_hp: document.getElementById('no_hp').value,
                no_rekening: document.getElementById('no_rekening').value,
                status_pernikahan: document.getElementById('status_pernikahan').value,
                nama_pasangan: document.getElementById('nama_pasangan').value,
                tanggal_lahir_pasangan: document.getElementById('tanggal_lahir_pasangan').value,
                tanggal_pernikahan: document.getElementById('tanggal_pernikahan').value,
                tanggal_cerai: document.getElementById('tanggal_cerai').value,
                tanggal_wafat: document.getElementById('tanggal_wafat').value,
                pekerjaan_pasangan: document.getElementById('pekerjaan_pasangan').value,
                // Children data
                children: []
            };

            // Collect children data
            for (let i = 1; i <= childCounter; i++) {
                const namaAnak = document.getElementById(`anak_nama_${i}`);
                if (namaAnak && namaAnak.value) {
                    formData.children.push({
                        nama: namaAnak.value,
                        tempat_lahir: document.getElementById(`anak_tempat_lahir_${i}`).value,
                        tanggal_lahir: document.getElementById(`anak_tanggal_lahir_${i}`).value,
                        jenis_kelamin: document.getElementById(`anak_jenis_kelamin_${i}`).value,
                        pekerjaan: document.getElementById(`anak_pekerjaan_${i}`).value
                    });
                }
            }

            // Check for duplicate NIP
            const existingData = userData.find(item => item.nip === formData.nip);
            if (existingData) {
                showAlert('error', 'NIP sudah terdaftar! Gunakan NIP yang berbeda.');
                return;
            }

            // Save to userData array
            userData.push(formData);
            localStorage.setItem('pegawaiData', JSON.stringify(userData));

            showAlert('success', 'Data berhasil disimpan!');
            
            // Reset form
            resetForm();
            
            // Generate new captcha
            generateCaptcha();
            
            // Clear draft
            localStorage.removeItem('formDraft');
            
            // Update admin data if admin panel is open
            loadData();
            updateStatistics();
        }

        function resetForm() {
            // Reset all form fields
            document.querySelectorAll('#user-section input, #user-section select, #user-section textarea').forEach(field => {
                field.value = '';
                field.style.borderColor = '#e1e8ed';
            });

            // Reset children forms
            document.getElementById('children-forms').innerHTML = '';
            childCounter = 0;

            // Reset to step 1
            currentStep = 1;
            document.getElementById('form-step2').style.display = 'none';
            document.getElementById('form-step1').style.display = 'block';
            
            // Reset progress indicators
            document.getElementById('step1').className = 'progress-step active';
            document.getElementById('step2').className = 'progress-step';

            // Hide marriage details
            document.getElementById('marriage-details').style.display = 'none';
            
            // Reset captcha
            document.getElementById('captcha-input').value = '';
            generateCaptcha();
        }

        // Alert system
        function showAlert(type, message) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alertElement = document.getElementById(alertId);
            alertElement.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + message;
            alertElement.style.display = 'block';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
            
            // Scroll to top to show alert
            document.querySelector('.container').scrollTop = 0;
        }

        // Admin functions
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            if (password === 'admin123') {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadData();
                updateStatistics();
                
                // Clear password field for security
                document.getElementById('admin-password').value = '';
            } else {
                alert('‚ùå Password salah! Silakan periksa kembali password Anda.');
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password').focus();
            }
        }

        function adminLogout() {
            document.getElementById('admin-login').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }

        function loadData() {
            const tbody = document.getElementById('data-tbody');
            
            if (userData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Belum ada data tersimpan</td></tr>';
                return;
            }

            let html = '';
            userData.forEach((data, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${data.nip}</td>
                        <td>${data.nama}</td>
                        <td>${data.ktp}</td>
                        <td>${data.alamat.substring(0, 50)}${data.alamat.length > 50 ? '...' : ''}</td>
                        <td>${data.tempat_lahir}, ${formatDate(data.tanggal_lahir)}</td>
                        <td><span style="background: ${getStatusColor(data.status_pernikahan)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${formatStatus(data.status_pernikahan)}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="viewDetail(${data.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;">üëÅÔ∏è Detail</button>
                            <button class="btn btn-danger" onclick="deleteData(${data.id})" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è Hapus</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateStatistics() {
            const total = userData.length;
            const married = userData.filter(data => data.status_pernikahan === 'MENIKAH').length;
            const single = userData.filter(data => data.status_pernikahan === 'BELUM_MENIKAH').length;

            document.getElementById('total-records').textContent = total;
            document.getElementById('married-count').textContent = married;
            document.getElementById('single-count').textContent = single;
        }

        function searchData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filteredData = userData.filter(data => 
                data.nama.toLowerCase().includes(searchTerm) ||
                data.nip.toLowerCase().includes(searchTerm) ||
                data.ktp.toLowerCase().includes(searchTerm)
            );

            displayFilteredData(filteredData);
        }

        function displayFilteredData(data) {
            const tbody = document.getElementById('data-tbody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Data tidak ditemukan</td></tr>';
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.nip}</td>
                        <td>${item.nama}</td>
                        <td>${item.ktp}</td>
                        <td>${item.alamat.substring(0, 50)}${item.alamat.length > 50 ? '...' : ''}</td>
                        <td>${item.tempat_lahir}, ${formatDate(item.tanggal_lahir)}</td>
                        <td><span style="background: ${getStatusColor(item.status_pernikahan)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${formatStatus(item.status_pernikahan)}</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="viewDetail(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 5px;">üëÅÔ∏è Detail</button>
                            <button class="btn btn-danger" onclick="deleteData(${item.id})" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è Hapus</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function viewDetail(id) {
            const data = userData.find(item => item.id === id);
            if (!data) return;

            let childrenHtml = '';
            if (data.children && data.children.length > 0) {
                childrenHtml = '<h4>üë∂ Data Anak:</h4><div style="display: grid; gap: 15px;">';
                data.children.forEach((child, index) => {
                    childrenHtml += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <h5>Anak ke-${index + 1}</h5>
                            <p><strong>Nama:</strong> ${child.nama || '-'}</p>
                            <p><strong>TTL:</strong> ${child.tempat_lahir || '-'}, ${child.tanggal_lahir ? formatDate(child.tanggal_lahir) : '-'}</p>
                            <p><strong>Jenis Kelamin:</strong> ${child.jenis_kelamin || '-'}</p>
                            <p><strong>Pekerjaan:</strong> ${child.pekerjaan || '-'}</p>
                        </div>
                    `;
                });
                childrenHtml += '</div>';
            } else {
                childrenHtml = '<h4>üë∂ Data Anak:</h4><p style="color: #666; font-style: italic;">Tidak ada data anak</p>';
            }

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <h2>üìã Detail Data Pegawai</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div>
                        <h4>üìä Data Utama</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p><strong>NIP:</strong> ${data.nip}</p>
                            <p><strong>Nama:</strong> ${data.nama}</p>
                            <p><strong>No. KTP:</strong> ${data.ktp}</p>
                            <p><strong>Alamat:</strong> ${data.alamat}</p>
                            <p><strong>TTL:</strong> ${data.tempat_lahir}, ${formatDate(data.tanggal_lahir)}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h4>üìÑ Data Lanjutan</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p><strong>Agama:</strong> ${data.agama || '-'}</p>
                            <p><strong>NPWP:</strong> ${data.npwp || '-'}</p>
                            <p><strong>No. HP:</strong> ${data.no_hp || '-'}</p>
                            <p><strong>No. Rekening:</strong> ${data.no_rekening || '-'}</p>
                            <p><strong>Status Pernikahan:</strong> ${formatStatus(data.status_pernikahan)}</p>
                        </div>
                    </div>
                </div>

                ${(data.status_pernikahan === 'MENIKAH' || data.status_pernikahan === 'CERAI_HIDUP' || data.status_pernikahan === 'CERAI_MATI') ? `
                <div style="margin-bottom: 30px;">
                    <h4>üíë Data Keluarga</h4>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <p><strong>Nama Suami/Istri:</strong> ${data.nama_pasangan || '-'}</p>
                        <p><strong>Tanggal Lahir:</strong> ${data.tanggal_lahir_pasangan ? formatDate(data.tanggal_lahir_pasangan) : '-'}</p>
                        <p><strong>Tanggal Pernikahan:</strong> ${data.tanggal_pernikahan ? formatDate(data.tanggal_pernikahan) : '-'}</p>
                        <p><strong>Tanggal Cerai:</strong> ${data.tanggal_cerai ? formatDate(data.tanggal_cerai) : '-'}</p>
                        <p><strong>Tanggal Wafat:</strong> ${data.tanggal_wafat ? formatDate(data.tanggal_wafat) : '-'}</p>
                        <p><strong>Pekerjaan:</strong> ${data.pekerjaan_pasangan || '-'}</p>
                    </div>
                </div>
                ` : ''}

                <div>
                    ${childrenHtml}
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-danger" onclick="deleteData(${data.id}); closeModal();">üóëÔ∏è Hapus Data</button>
                    <button class="btn btn-secondary" onclick="closeModal()">‚úñÔ∏è Tutup</button>
                </div>
            `;

            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function deleteData(id) {
            if (confirm('‚ö†Ô∏è Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.')) {
                userData = userData.filter(item => item.id !== id);
                localStorage.setItem('pegawaiData', JSON.stringify(userData));
                loadData();
                updateStatistics();
                
                // Show success message
                const alertElement = document.createElement('div');
                alertElement.className = 'alert alert-success';
                alertElement.textContent = '‚úÖ Data berhasil dihapus!';
                alertElement.style.display = 'block';
                document.querySelector('#admin-panel').insertBefore(alertElement, document.querySelector('.admin-controls'));
                
                setTimeout(() => {
                    alertElement.remove();
                }, 3000);
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
                if (confirm('üö® KONFIRMASI TERAKHIR: Semua data pegawai akan dihapus permanen. Lanjutkan?')) {
                    userData = [];
                    localStorage.removeItem('pegawaiData');
                    loadData();
                    updateStatistics();
                    alert('‚úÖ Semua data telah berhasil dihapus.');
                }
            }
        }

        function exportToExcel() {
            if (userData.length === 0) {
                alert('‚ùå Tidak ada data untuk di-export!');
                return;
            }

            // Prepare data for Excel
            const excelData = userData.map((data, index) => ({
                'No': index + 1,
                'NIP': data.nip,
                'Nama Lengkap': data.nama,
                'No. KTP': data.ktp,
                'Alamat': data.alamat,
                'Tempat Lahir': data.tempat_lahir,
                'Tanggal Lahir': formatDate(data.tanggal_lahir),
                'Agama': data.agama || '-',
                'NPWP': data.npwp || '-',
                'No. HP': data.no_hp || '-',
                'No. Rekening': data.no_rekening || '-',
                'Status Pernikahan': formatStatus(data.status_pernikahan),
                'Nama Suami/Istri': data.nama_pasangan || '-',
                'TTL Suami/Istri': data.tanggal_lahir_pasangan ? formatDate(data.tanggal_lahir_pasangan) : '-',
                'Tanggal Pernikahan': data.tanggal_pernikahan ? formatDate(data.tanggal_pernikahan) : '-',
                'Tanggal Cerai': data.tanggal_cerai ? formatDate(data.tanggal_cerai) : '-',
                'Tanggal Wafat': data.tanggal_wafat ? formatDate(data.tanggal_wafat) : '-',
                'Pekerjaan Suami/Istri': data.pekerjaan_pasangan || '-',
                'Jumlah Anak': data.children ? data.children.length : 0,
                'Data Anak': data.children && data.children.length > 0 ? 
                    data.children.map((child, i) => 
                        `Anak ${i+1}: ${child.nama || '-'} (${child.tempat_lahir || '-'}, ${child.tanggal_lahir ? formatDate(child.tanggal_lahir) : '-'}) - ${child.jenis_kelamin || '-'} - ${child.pekerjaan || '-'}`
                    ).join(' | ') : '-',
                'Tanggal Input': new Date(data.timestamp).toLocaleDateString('id-ID')
            }));

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Set column widths
            const colWidths = [
                {wch: 5},   // No
                {wch: 20},  // NIP
                {wch: 30},  // Nama
                {wch: 18},  // KTP
                {wch: 40},  // Alamat
                {wch: 15},  // Tempat Lahir
                {wch: 12},  // Tanggal Lahir
                {wch: 12},  // Agama
                {wch: 18},  // NPWP
                {wch: 15},  // No HP
                {wch: 18},  // Rekening
                {wch: 15},  // Status
                {wch: 25},  // Nama Pasangan
                {wch: 15},  // TTL Pasangan
                {wch: 15},  // Tgl Nikah
                {wch: 12},  // Tgl Cerai
                {wch: 12},  // Tgl Wafat
                {wch: 20},  // Pekerjaan Pasangan
                {wch: 12},  // Jumlah Anak
                {wch: 50},  // Data Anak
                {wch: 15}   // Tanggal Input
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, 'Data Pegawai');

            // Generate filename with current date
            const currentDate = new Date().toISOString().split('T')[0];
            const filename = `Data_Pegawai_${currentDate}.xlsx`;

            // Save file
            XLSX.writeFile(wb, filename);
            
            alert(`‚úÖ Data berhasil di-export ke file: ${filename}`);
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function formatStatus(status) {
            const statusMap = {
                'BELUM_MENIKAH': 'Belum Menikah',
                'MENIKAH': 'Menikah',
                'CERAI_HIDUP': 'Cerai Hidup',
                'CERAI_MATI': 'Cerai Mati'
            };
            return statusMap[status] || '-';
        }

        function getStatusColor(status) {
            const colorMap = {
                'BELUM_MENIKAH': '#6c757d',
                'MENIKAH': '#28a745',
                'CERAI_HIDUP': '#ffc107',
                'CERAI_MATI': '#dc3545'
            };
            return colorMap[status] || '#6c757d';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Form validation on input
        document.addEventListener('input', function(e) {
            if (e.target.id === 'nip') {
                e.target.value = e.target.value.replace(/\D/g, '');
            } else if (e.target.id === 'ktp') {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 16);
            } else if (e.target.id === 'npwp') {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 15);
            } else if (e.target.id === 'no_hp') {
                let value = e.target.value.replace(/\D/g, '');
                if (value && !value.startsWith('08')) {
                    value = '08' + value;
                }
                e.target.value = value;
            } else if (e.target.id === 'no_rekening') {
                e.target.value = e.target.value.replace(/\D/g, '');
            } else if (e.target.id === 'nama') {
                e.target.value = e.target.value.toUpperCase();
            }
        });

        // Auto-save draft (optional feature)
        let draftTimer;
        function saveDraft() {
            clearTimeout(draftTimer);
            draftTimer = setTimeout(() => {
                const formData = {};
                document.querySelectorAll('#user-section input, #user-section select, #user-section textarea').forEach(field => {
                    if (field.value) formData[field.id] = field.value;
                });
                localStorage.setItem('formDraft', JSON.stringify(formData));
            }, 2000);
        }

        function loadDraft() {
            const draft = localStorage.getItem('formDraft');
            if (draft) {
                const formData = JSON.parse(draft);
                Object.keys(formData).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = formData[fieldId];
                });
            }
        }

        // Load draft on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDraft();
            generateCaptcha();
        });

        // Save draft on input
        document.addEventListener('input', saveDraft);

        // Captcha input validation
        document.addEventListener('input', function(e) {
            if (e.target.id === 'captcha-input') {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
            }
        });

        // Enter key support for captcha and admin login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.id === 'captcha-input') {
                    saveData();
                } else if (e.target.id === 'admin-password') {
                    adminLogin();
                }
            }
        });
    </script>
</body>
</html>